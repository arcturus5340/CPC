{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../static/@chrisoakman/chessboardjs/dist/chessboard-1.0.0.css"/>
</head>
<body>

    <button onclick="add_board()">Новая доска</button>

    <script src="{% static "jquery/dist/jquery.js" %}"></script>
    <script src="{% static "@chrisoakman/chessboardjs/dist/chessboard-1.0.0.js" %}"></script>

    <div id="chess_boards"></div>

    <script>
        let boards = {};

        function add_board(){
            $.ajax({
                url: '/add_board/',
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: function(response){
                    update_boards();
                },
                error: function() {
                }
            })
        }

        function update_boards(){
            $.ajax({
                url: '/update_boards/',
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: function(response) {
                    let server_board_ids = Object.keys(response['ChessBoards']);
                    let local_board_ids = Object.keys(boards);
                    let new_board_ids = server_board_ids.filter(x => !local_board_ids.includes(x));
                    new_board_ids.forEach(function(id){
                        $('#chess_boards').append('<div id="board-'+id+'" class="chess_board" style="width: 200px"></div>');
                        boards[id] = ChessBoard('board-'+id, {position: response['ChessBoards'][id], moveSpeed: 'slow'});
                    });

                    for (const id in response['ChessBoards']){
                        let current_fen = response['ChessBoards'][id];
                        boards[id].position(current_fen);
                    }

                    server_board_ids = Object.keys(response['ChessBoards']);
                    local_board_ids = Object.keys(boards);
                    let old_board_ids = local_board_ids.filter(x => !server_board_ids.includes(x));
                    old_board_ids.forEach(function(id){
                        $('#board-'+id).remove();
                        delete boards[id];
                    });
                },
                error: function() {
                }
            })
        }

        update_boards();
        window.setInterval(update_boards, 1000);

    </script>
</body>
</html>